/*
 * Test configuration for GSE145838 with Docker-enabled CellRanger
 */

params {
    // Input
    sra_table = "SraRunTable.csv"
    outdir = "./results"
    sample_limit = null  // Process all samples
    debug = true

    // Data download
    auto_detect_format = true
    prefer_original_format = true
    download_threads = 4
    prefetch_max_size = "200G"
    use_kingfisher = false
    kingfisher_methods = "ena-ascp ena-ftp prefetch"  // Define even if not using

    // Docker only for CellRanger, local tools for everything else
    use_container = true  // Needed for CellRanger to use /ref path
    use_conda = null  // No conda activation - use current environment
    container_engine = 'docker'
    cellranger_ref = "/ref"  // Inside container
    cellranger_localcores = 4  // Adjust based on your system
    cellranger_localmem_gb = 16  // Adjust based on your system
    cellranger_nosecondary = true
    cellranger_disable_ui = true
    cellranger_create_bam = false  // Start without BAM to save space
    cellranger_expect_cells = null
    cellranger_extra = ""

    // STARsolo (if needed for non-10x)
    star_index = null  // Not using for this test
    star_threads = 4
    memory_per_sample = "16 GB"

    // Velocyto - disabled for initial test
    run_velocyto = false

    // Storage
    keep_raw = false
    keep_fastq = false  // Save space for test
    keep_bam = false
    workdir_clean = false  // Keep work dir for debugging

    // Execution
    executor = 'local'
    scratch = false
    max_samples_parallel = 1  // Process one at a time for testing
    max_download_parallel = 2

    // Alternative quantifiers
    quantifier = "auto"  // Auto-detect chemistry
}

// Docker settings
docker {
    enabled = true  // Enable Docker support
    temp = 'auto'

    // Mount CellRanger reference (using your existing reference)
    runOptions = '-v /Users/miana/sc-sra-nf/cellranger/refdata-gex-GRCh38-2024-A:/ref:ro'
}

process {
    // Only use Docker for CellRanger
    withName: CELLRANGER_COUNT {
        container = 'litd/docker-cellranger:latest'
        cpus = 4
        memory = '16 GB'
        time = '24h'
    }

    // All other processes use local tools (no container)
    withName: 'VALIDATE_SAMPLE|DOWNLOAD_RUNS|CLEAN_TABLE|RENAME_VALIDATE|PRECHECK|FINALIZE_SAMPLE|PUBLISH_RESULTS|AGGREGATE_SUMMARY' {
        container = null
    }
}

// Execution profile
profiles {
    standard {
        process.executor = 'local'
    }

    test {
        params.sample_limit = 1  // Test with just one sample
        params.debug = true
    }

    debug {
        process.echo = true
        params.debug = true
    }
}

// Reporting
report {
    enabled = true
    overwrite = true
    file = "${params.outdir}/pipeline_report.html"
}

timeline {
    enabled = true
    overwrite = true
    file = "${params.outdir}/pipeline_timeline.html"
}

trace {
    enabled = true
    overwrite = true
    file = "${params.outdir}/pipeline_trace.txt"
}

// Clean up
cleanup = false  // Keep for debugging